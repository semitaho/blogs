<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Web Application</title>
  </head>
  <body>
    <h1>Welcome to My Web Application</h1>
    <p>This is a simple web application using Spring Boot.</p>
    <p>Click the button to ask something from ChatGPT</p>
    <form onsubmit="return false;">
      <button
        id="startRecordingButton"
        style="padding: 5px; width: 30%; margin-top: 10px"
        onclick="startRecording()"
      >
        Start recording question
      </button>
      <button
        id="stopRecordingButton"
        style="padding: 5px; width: 30%; margin-top: 10px"
        onclick="stopRecording()"
      >
        Stop recording question
      </button>
    </form>

    <p id="message" style="display: none">Hello, this is a message!</p>
    <img
      id="openapi-image"
      style="display: none"
      src=""
      width="400"
      height="400"
      alt="prefetched image"
    />
    <script>
      toggleButtons(false);

      let mediaRecorder = null;
      let chunks = [];
      const mimeType = "audio/webm"; // or "audio/webm" based on your needs

      function toggleButtons(playing) {
        if (playing) {
          document.getElementById("stopRecordingButton").style.display =
            "inline-block";
          document.getElementById("startRecordingButton").style.display =
            "none";
        } else {
          document.getElementById("startRecordingButton").style.display =
            "inline-block";
          document.getElementById("stopRecordingButton").style.display = "none";
        }
      }
      function startRecording() {
        console.log("Starting recording...", navigator.mediaDevices);
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          console.log("getUserMedia supported.");
          navigator.mediaDevices
            .getUserMedia(
              // constraints - only audio needed for this app
              {
                audio: true,
              }
            )

            // Success callback
            .then((stream) => {
              mediaRecorder = new MediaRecorder(stream);
              console.log("MediaRecorder created:", mediaRecorder);
              mediaRecorder.start();
              console.log(mediaRecorder.state);
              toggleButtons(true);
              mediaRecorder.ondataavailable = (e) => {
                chunks.push(e.data);
              };
              mediaRecorder.onstop = (e) => {
                console.log("recorder stopped");
                toggleButtons(false);
                const blob = new Blob(chunks, {
                  type: mimeType,
                });

                fetch("/upload", {
                  method: "POST",
                  headers: {
                    "Content-Type": mimeType, // or correct MIME
                  },
                  body: blob,
                })
                  .then((response) => response.arrayBuffer())
                  .then((arrayBuffer) => {
                    const blob = new Blob([arrayBuffer], {
                      type: "audio/webm",
                    }); // use correct MIME
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    audio.play();
                  });
                chunks = []; // reset chunks for next recording
              };
            })

            // Error callback
            .catch((err) => {
              console.error(
                `The following getUserMedia error occurred: ${err}`
              );
            });
          return;
        }
        document.getElementById("messageButton").disabled = true;
        fetch("/start-recording", {
          method: "POST",
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Recording started:", data);
            document.getElementById("messageButton").disabled = false;
          })
          .catch((error) => console.error("Error starting recording:", error));
      }

      function stopRecording() {
        mediaRecorder.stop();
        console.log(mediaRecorder.state);
        console.log("recorder stopped");
      }

      function processAudio(prompt) {
        document.getElementById("messageButton").disabled = true;
        fetch("/audio?prompt=" + prompt, {
          method: "GET",
          headers: {
            Accept: "audio/mpeg", // or 'application/octet-stream', depending on backend
          },
        })
          .then((response) => response.arrayBuffer())
          .then((arrayBuffer) => {
            const blob = new Blob([arrayBuffer], { type: "audio/mpeg" }); // use correct MIME
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            document.getElementById("messageButton").disabled = false;
            audio.play();
          })
          .catch((error) => console.error("Error playing audio:", error));
      }
      //processAudio("Tell me, what is happening in the world");

      // processImage();
    </script>
  </body>
</html>
